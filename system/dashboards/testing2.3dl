<Dashboards>
  <Datasets>
    <SQLData name="week_data" queryName="filters/week_names" />
  </Datasets>

  <Dashboard
    data="current_date_data"
    tabName="HVL Weekly Reporting"
    title=""
    subTitle="HVL Weekly Reporting"
    lastRefresh=""
  >
    <Filters>
        <Filter caption="Select Week" name="week_name" data="week_data" />
    </Filters>

    

    <Grid>
      <Row columns="1" largeColumns="1">
      <SQLData name="hvl_report_transformation_table_data">
          SELECT
            FORMAT(CAST(SUBSTRING(dd.weekly_start_monday_day_dates, 1, CHARINDEX('-', dd.weekly_start_monday_day_dates) - 2) AS DATE), 'yyyy-MM-dd') 
            + ' to ' + 
            FORMAT(CAST(SUBSTRING(dd.weekly_start_monday_day_dates, CHARINDEX('-', dd.weekly_start_monday_day_dates) + 2, LEN(dd.weekly_start_monday_day_dates)) AS DATE), 'yyyy-MM-dd') 
            AS week,
            SUM(fd.hvl_sample_collected) AS [Sample Collected],
            SUM(fd.hvl_sample_received) AS [Sample Received],
            SUM(fd.hvl_sample_accepted) AS [Sample Accepted],
            SUM(fd.hvl_sample_rejected) AS [Sample Rejected],
            SUM(fd.hvl_sample_tested) AS [Sample Tested],
            SUM(fd.hvl_result_pending) AS [Pending Results],
            SUM(fd.hvl_result_authorized) AS [Authorized Results],
            SUM(fd.hvl_result_accepted) AS [Accepted Results],
            SUM(fd.hvl_result_rejected) AS [Rejected Results],
            SUM(fd.hvl_result_failed) AS [Failed Results],
            SUM(fd.hvl_result_invalid) AS [Invalid Results]
          FROM 
              [final].fact_daily_sample_summary fd
          INNER JOIN 
              [derived].dim_date dd 
          ON 
            fd.report_date = dd.[date]
          WHERE 
            dd.date BETWEEN 
            CONVERT(DATE, 
                SUBSTRING('$week_name', CHARINDEX(':', '$week_name') + 2, CHARINDEX('-', '$week_name') - CHARINDEX(':', '$week_name') - 3), 101
            ) 
            AND 
            CONVERT(DATE, 
                SUBSTRING('$week_name', CHARINDEX('-', '$week_name') + 2, LEN('$week_name')), 101
            )
          GROUP BY 
              dd.weekly_start_monday_day_dates;
        </SQLData>
        <Table
          data="hvl_report_transformation_table_data"
          header="HVL Report Transformation Table"
          subheader="HVL Report Transformation Table"
          exportData="true"
          variant="plain"
        />
      </Row>
    
    </Grid>
  </Dashboard>

</Dashboards>
